# SmartOS æœ¬åœ°åŒ–å¼€å‘æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

**ç›®æ ‡**ï¼šå®ç°å®Œå…¨æœ¬åœ°åŒ–çš„å¼€å‘ç¯å¢ƒï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡å™¨ï¼ˆå¦‚ superacme.comï¼‰ï¼Œå®ç°BC4 Proè®¾å¤‡çš„æœ¬åœ°æ¨¡æ‹Ÿå’Œé€šä¿¡ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨å¯æ§çš„å¼€å‘ç¯å¢ƒ
- âœ… ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œå¼€å‘æ›´ç¨³å®š
- âœ… å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯å’Œå¼‚å¸¸æƒ…å†µ
- âœ… ä¾¿äºæµ‹è¯•å’Œè°ƒè¯•
- âœ… æ•°æ®éšç§å’Œå®‰å…¨

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æœ¬åœ°åŒ–æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SmartOS åç«¯æœåŠ¡                 â”‚
â”‚  (Spring Boot - localhost:8080)        â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  BC4 Pro è®¾å¤‡æ¨¡æ‹Ÿå™¨              â”‚  â”‚
â”‚  â”‚  - HTTP API æ¨¡æ‹Ÿ                 â”‚  â”‚
â”‚  â”‚  - MQTT æ¶ˆæ¯æ¨¡æ‹Ÿ                 â”‚  â”‚
â”‚  â”‚  - å…‰æ„Ÿæ•°æ®ç”Ÿæˆ                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ™ºèƒ½çª—å¸˜æ§åˆ¶å™¨æ¨¡æ‹Ÿå™¨            â”‚  â”‚
â”‚  â”‚  - MQTT è®¢é˜…/å‘å¸ƒ               â”‚  â”‚
â”‚  â”‚  - çª—å¸˜çŠ¶æ€æ¨¡æ‹Ÿ                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MQTT    â”‚         â”‚  HTTP    â”‚
    â”‚ Broker   â”‚         â”‚  API     â”‚
    â”‚(æœ¬åœ°)    â”‚         â”‚(æœ¬åœ°)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. BC4 Pro è®¾å¤‡æ¨¡æ‹Ÿå™¨

#### åŠŸèƒ½éœ€æ±‚

- **HTTP API æ¨¡æ‹Ÿ**ï¼šæ¨¡æ‹ŸBC4 Proçš„HTTPæ¥å£
- **MQTT æ¶ˆæ¯æ¨¡æ‹Ÿ**ï¼šæ¨¡æ‹Ÿè®¾å¤‡MQTTé€šä¿¡
- **å…‰æ„Ÿæ•°æ®ç”Ÿæˆ**ï¼šç”Ÿæˆæ¨¡æ‹Ÿçš„å…‰ç…§æ•°æ®
- **è®¾å¤‡çŠ¶æ€ç®¡ç†**ï¼šç®¡ç†è®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€
- **é…ç½®ç®¡ç†**ï¼šæ¨¡æ‹Ÿè®¾å¤‡é…ç½®åŠŸèƒ½

#### å®ç°æ–¹å¼

**æ–¹æ¡ˆAï¼šSpring Boot Mock Controllerï¼ˆæ¨èï¼‰**

åœ¨SmartOSåç«¯ä¸­åˆ›å»ºMock Controllerï¼Œæ¨¡æ‹ŸBC4 Proçš„APIï¼š

```java
@RestController
@RequestMapping("/mock/bc4")
public class BC4MockController {
    // æ¨¡æ‹ŸBC4 Proçš„HTTP API
}
```

**æ–¹æ¡ˆBï¼šç‹¬ç«‹çš„è®¾å¤‡æ¨¡æ‹Ÿå™¨æœåŠ¡**

åˆ›å»ºç‹¬ç«‹çš„Spring BootæœåŠ¡ï¼Œä¸“é—¨ç”¨äºè®¾å¤‡æ¨¡æ‹Ÿã€‚

**æ¨èæ–¹æ¡ˆA**ï¼Œå› ä¸ºï¼š
- é›†æˆç®€å•ï¼Œæ— éœ€é¢å¤–æœåŠ¡
- ä¾¿äºè°ƒè¯•å’Œæµ‹è¯•
- å¯ä»¥å¿«é€Ÿåˆ‡æ¢çœŸå®è®¾å¤‡å’Œæ¨¡æ‹Ÿè®¾å¤‡

### 2. æœ¬åœ°MQTT Broker

#### é€‰æ‹©æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šä½¿ç”¨ Mosquittoï¼ˆæ¨èï¼‰**
- è½»é‡çº§ï¼Œæ˜“äºéƒ¨ç½²
- æ”¯æŒæ ‡å‡†MQTTåè®®
- å¯ä»¥Dockerè¿è¡Œ

**æ–¹æ¡ˆBï¼šä½¿ç”¨ HiveMQ Community Edition**
- åŠŸèƒ½æ›´ä¸°å¯Œ
- Webç®¡ç†ç•Œé¢
- èµ„æºå ç”¨è¾ƒå¤§

**æ–¹æ¡ˆCï¼šä½¿ç”¨ Spring Integration MQTT**
- é›†æˆåˆ°Spring Bootä¸­
- æ— éœ€é¢å¤–æœåŠ¡
- åŠŸèƒ½ç›¸å¯¹ç®€å•

**æ¨èæ–¹æ¡ˆAï¼ˆMosquittoï¼‰**ï¼Œå› ä¸ºï¼š
- æ ‡å‡†MQTTå®ç°
- è½»é‡çº§ï¼Œæ˜“äºç®¡ç†
- å¯ä»¥Dockerä¸€é”®å¯åŠ¨

### 3. å…‰æ„Ÿæ•°æ®ç”Ÿæˆç­–ç•¥

#### æ•°æ®ç”Ÿæˆæ–¹å¼

1. **å›ºå®šå€¼æ¨¡å¼**ï¼šè¿”å›å›ºå®šçš„å…‰ç…§å€¼
2. **éšæœºå€¼æ¨¡å¼**ï¼šåœ¨æŒ‡å®šèŒƒå›´å†…éšæœºç”Ÿæˆ
3. **æ—¶é—´æ¨¡å¼**ï¼šæ ¹æ®æ—¶é—´æ¨¡æ‹Ÿå…‰ç…§å˜åŒ–ï¼ˆç™½å¤©/å¤œæ™šï¼‰
4. **æ–‡ä»¶æ¨¡å¼**ï¼šä»é…ç½®æ–‡ä»¶æˆ–CSVè¯»å–æ•°æ®
5. **ç®—æ³•æ¨¡å¼**ï¼šä½¿ç”¨ç®—æ³•æ¨¡æ‹ŸçœŸå®å…‰ç…§æ›²çº¿

#### æ¨èç­–ç•¥

**æ—¶é—´æ¨¡å¼ + éšæœºæ³¢åŠ¨**ï¼š
- ç™½å¤©ï¼ˆ6:00-18:00ï¼‰ï¼š200-800 lux
- å¤œæ™šï¼ˆ18:00-6:00ï¼‰ï¼š0-50 lux
- æ·»åŠ éšæœºæ³¢åŠ¨æ¨¡æ‹ŸçœŸå®ç¯å¢ƒ

---

## ğŸ’» å®ç°ä»£ç 

### 1. BC4 Pro Mock Controller

```java
package com.smartos.mock.device;

import com.smartos.common.Result;
import lombok.Data;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;

/**
 * BC4 Pro è®¾å¤‡æ¨¡æ‹Ÿå™¨
 */
@RestController
@RequestMapping("/mock/bc4")
public class BC4MockController {
    
    private final Random random = new Random();
    private final Map<String, DeviceState> deviceStates = new HashMap<>();
    
    /**
     * è·å–è®¾å¤‡çŠ¶æ€
     */
    @GetMapping("/{deviceId}/status")
    public Result<DeviceStatus> getDeviceStatus(@PathVariable String deviceId) {
        DeviceState state = getOrCreateDeviceState(deviceId);
        
        DeviceStatus status = new DeviceStatus();
        status.setDeviceId(deviceId);
        status.setOnline(true);
        status.setBatteryLevel(state.getBatteryLevel());
        status.setSignalStrength(state.getSignalStrength());
        status.setTimestamp(LocalDateTime.now());
        
        return Result.success(status);
    }
    
    /**
     * è·å–å…‰æ„Ÿæ•°æ®
     */
    @GetMapping("/{deviceId}/lightSensor")
    public Result<LightSensorData> getLightSensor(@PathVariable String deviceId) {
        DeviceState state = getOrCreateDeviceState(deviceId);
        
        // ç”Ÿæˆå…‰æ„Ÿæ•°æ®ï¼ˆæ ¹æ®æ—¶é—´æ¨¡æ‹Ÿï¼‰
        double lightValue = generateLightValue();
        
        LightSensorData data = new LightSensorData();
        data.setDeviceId(deviceId);
        data.setLightValue(lightValue);
        data.setTimestamp(LocalDateTime.now());
        data.setDataSource("mock");
        
        return Result.success(data);
    }
    
    /**
     * å‘é€è®¾å¤‡å‘½ä»¤
     */
    @PostMapping("/{deviceId}/command")
    public Result<CommandResponse> sendCommand(
            @PathVariable String deviceId,
            @RequestBody CommandRequest request) {
        
        DeviceState state = getOrCreateDeviceState(deviceId);
        
        // æ¨¡æ‹Ÿå‘½ä»¤æ‰§è¡Œ
        CommandResponse response = new CommandResponse();
        response.setDeviceId(deviceId);
        response.setCommand(request.getCommand());
        response.setSuccess(true);
        response.setMessage("å‘½ä»¤æ‰§è¡ŒæˆåŠŸ");
        response.setTimestamp(LocalDateTime.now());
        
        return Result.success(response);
    }
    
    /**
     * ç”Ÿæˆå…‰æ„Ÿæ•°æ®ï¼ˆæ ¹æ®æ—¶é—´æ¨¡æ‹Ÿï¼‰
     */
    private double generateLightValue() {
        int hour = LocalDateTime.now().getHour();
        
        // ç™½å¤©ï¼ˆ6:00-18:00ï¼‰ï¼š200-800 lux
        if (hour >= 6 && hour < 18) {
            return 200 + random.nextDouble() * 600;
        }
        // å¤œæ™šï¼ˆ18:00-6:00ï¼‰ï¼š0-50 lux
        else {
            return random.nextDouble() * 50;
        }
    }
    
    private DeviceState getOrCreateDeviceState(String deviceId) {
        return deviceStates.computeIfAbsent(deviceId, k -> {
            DeviceState state = new DeviceState();
            state.setDeviceId(deviceId);
            state.setBatteryLevel(80 + random.nextInt(20)); // 80-100%
            state.setSignalStrength(-50 - random.nextInt(30)); // -50 to -80 dBm
            return state;
        });
    }
    
    @Data
    static class DeviceState {
        private String deviceId;
        private int batteryLevel;
        private int signalStrength;
    }
    
    @Data
    static class DeviceStatus {
        private String deviceId;
        private boolean online;
        private int batteryLevel;
        private int signalStrength;
        private LocalDateTime timestamp;
    }
    
    @Data
    static class LightSensorData {
        private String deviceId;
        private double lightValue;
        private LocalDateTime timestamp;
        private String dataSource;
    }
    
    @Data
    static class CommandRequest {
        private String command;
        private Map<String, Object> params;
    }
    
    @Data
    static class CommandResponse {
        private String deviceId;
        private String command;
        private boolean success;
        private String message;
        private LocalDateTime timestamp;
    }
}
```

### 2. MQTT Mock Publisherï¼ˆæ¨¡æ‹Ÿè®¾å¤‡MQTTæ¶ˆæ¯ï¼‰

```java
package com.smartos.mock.mqtt;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.eclipse.paho.client.mqttv3.MqttClient;
import org.eclipse.paho.client.mqttv3.MqttConnectOptions;
import org.eclipse.paho.client.mqttv3.MqttMessage;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;

/**
 * BC4 Pro MQTT æ¶ˆæ¯æ¨¡æ‹Ÿå™¨
 */
@Slf4j
@Component
public class BC4MqttMockPublisher {
    
    @Value("${smartos.mqtt.broker-url:tcp://localhost:1883}")
    private String brokerUrl;
    
    @Value("${smartos.mqtt.client-id:bc4-mock-publisher}")
    private String clientId;
    
    private MqttClient mqttClient;
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final Random random = new Random();
    
    @PostConstruct
    public void init() {
        try {
            mqttClient = new MqttClient(brokerUrl, clientId);
            MqttConnectOptions options = new MqttConnectOptions();
            options.setAutomaticReconnect(true);
            options.setCleanSession(true);
            mqttClient.connect(options);
            log.info("BC4 MQTT Mock Publisher å·²è¿æ¥: {}", brokerUrl);
        } catch (Exception e) {
            log.error("MQTTè¿æ¥å¤±è´¥", e);
        }
    }
    
    /**
     * å®šæ—¶å‘å¸ƒå…‰æ„Ÿæ•°æ®ï¼ˆæ¯åˆ†é’Ÿï¼‰
     */
    @Scheduled(fixedRate = 60000)
    public void publishLightSensorData() {
        if (mqttClient == null || !mqttClient.isConnected()) {
            return;
        }
        
        try {
            // æ¨¡æ‹Ÿå¤šä¸ªBC4è®¾å¤‡
            String[] deviceIds = {"BC4_001", "BC4_002"};
            
            for (String deviceId : deviceIds) {
                double lightValue = generateLightValue();
                
                Map<String, Object> data = new HashMap<>();
                data.put("deviceId", deviceId);
                data.put("lightValue", lightValue);
                data.put("timestamp", LocalDateTime.now().toString());
                data.put("dataSource", "mock");
                
                String topic = String.format("/smartos/bc4/%s/lightSensor", deviceId);
                String payload = objectMapper.writeValueAsString(data);
                
                MqttMessage message = new MqttMessage(payload.getBytes());
                message.setQos(1);
                message.setRetained(false);
                
                mqttClient.publish(topic, message);
                log.debug("å‘å¸ƒå…‰æ„Ÿæ•°æ®: {} -> {}", topic, payload);
            }
        } catch (Exception e) {
            log.error("å‘å¸ƒMQTTæ¶ˆæ¯å¤±è´¥", e);
        }
    }
    
    /**
     * ç”Ÿæˆå…‰æ„Ÿæ•°æ®
     */
    private double generateLightValue() {
        int hour = LocalDateTime.now().getHour();
        
        if (hour >= 6 && hour < 18) {
            // ç™½å¤©ï¼š200-800 lux
            return 200 + random.nextDouble() * 600;
        } else {
            // å¤œæ™šï¼š0-50 lux
            return random.nextDouble() * 50;
        }
    }
}
```

### 3. é…ç½®æ–‡ä»¶æ›´æ–°

```yaml
# application.yml
smartos:
  # æœ¬åœ°åŒ–é…ç½®
  local:
    enabled: true  # å¯ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼
    mock-device:
      enabled: true
      base-url: http://localhost:8080/mock/bc4
  
  # MQTTé…ç½®ï¼ˆæœ¬åœ°Mosquittoï¼‰
  mqtt:
    broker-url: tcp://localhost:1883
    client-id: smartos-client
    username: 
    password: 
    
  # BC4 Proé…ç½®ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰
  bc4:
    api:
      base-url: http://localhost:8080/mock/bc4  # ä½¿ç”¨æœ¬åœ°Mock API
      timeout: 5000
    light-sensor:
      collection-interval: 60
      default-open-threshold: 200.0
      default-close-threshold: 500.0
```

---

## ğŸ³ Docker é…ç½®ï¼ˆå¯é€‰ï¼‰

### Mosquitto MQTT Broker

```yaml
# docker-compose.yml
version: '3.8'

services:
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: smartos-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - smartos-network

networks:
  smartos-network:
    driver: bridge
```

### Mosquitto é…ç½®æ–‡ä»¶

```conf
# mosquitto/config/mosquitto.conf
listener 1883
allow_anonymous true
persistence true
persistence_location /mosquitto/data/
log_dest file /mosquitto/log/mosquitto.log
```

---

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### 1. å¯åŠ¨æœ¬åœ°MQTT Brokerï¼ˆå¯é€‰ï¼‰

```bash
# ä½¿ç”¨Docker
docker-compose up -d mosquitto

# æˆ–ç›´æ¥å®‰è£…Mosquitto
# macOS: brew install mosquitto
# Ubuntu: sudo apt-get install mosquitto
```

### 2. å¯åŠ¨SmartOSåç«¯

```bash
cd backend
mvn spring-boot:run
```

### 3. æµ‹è¯•Mock API

```bash
# è·å–è®¾å¤‡çŠ¶æ€
curl http://localhost:8080/mock/bc4/BC4_001/status

# è·å–å…‰æ„Ÿæ•°æ®
curl http://localhost:8080/mock/bc4/BC4_001/lightSensor

# å‘é€å‘½ä»¤
curl -X POST http://localhost:8080/mock/bc4/BC4_001/command \
  -H "Content-Type: application/json" \
  -d '{"command": "getStatus", "params": {}}'
```

### 4. è®¢é˜…MQTTæ¶ˆæ¯

```bash
# ä½¿ç”¨mosquitto_subè®¢é˜…
mosquitto_sub -h localhost -t "/smartos/bc4/+/lightSensor" -v
```

---

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

### 1. å®Œå…¨æœ¬åœ°åŒ–
- âœ… ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡å™¨
- âœ… æ•°æ®å®Œå…¨æœ¬åœ°æ§åˆ¶
- âœ… å¼€å‘ç¯å¢ƒç¨³å®šå¯é 

### 2. çµæ´»å¯æ§
- âœ… å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯
- âœ… å¯ä»¥æ¨¡æ‹Ÿå¼‚å¸¸æƒ…å†µ
- âœ… å¯ä»¥å¿«é€Ÿè°ƒæ•´å‚æ•°

### 3. ä¾¿äºæµ‹è¯•
- âœ… å¯ä»¥è‡ªåŠ¨åŒ–æµ‹è¯•
- âœ… å¯ä»¥å‹åŠ›æµ‹è¯•
- âœ… å¯ä»¥é›†æˆæµ‹è¯•

### 4. æ˜“äºæ‰©å±•
- âœ… å¯ä»¥æ·»åŠ æ›´å¤šæ¨¡æ‹Ÿè®¾å¤‡
- âœ… å¯ä»¥æ¨¡æ‹Ÿæ›´å¤šåŠŸèƒ½
- âœ… å¯ä»¥é›†æˆçœŸå®è®¾å¤‡ï¼ˆåˆ‡æ¢é…ç½®å³å¯ï¼‰

---

## ğŸ”„ åˆ‡æ¢åˆ°çœŸå®è®¾å¤‡

å½“éœ€è¦è¿æ¥çœŸå®BC4 Proè®¾å¤‡æ—¶ï¼Œåªéœ€ä¿®æ”¹é…ç½®ï¼š

```yaml
smartos:
  local:
    enabled: false  # ç¦ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼
  
  bc4:
    api:
      base-url: https://mall-cn.superacme.com  # ä½¿ç”¨çœŸå®API
```

ä»£ç æ— éœ€ä¿®æ”¹ï¼Œé€šè¿‡é…ç½®åˆ‡æ¢å³å¯ï¼

---

**æ€»ç»“**ï¼šæœ¬åœ°åŒ–å¼€å‘æ–¹æ¡ˆå®Œå…¨å¯è¡Œï¼Œä¸”å…·æœ‰æ›´å¥½çš„å¯æ§æ€§å’Œçµæ´»æ€§ï¼
