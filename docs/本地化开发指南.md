# SmartOS æœ¬åœ°åŒ–å¼€å‘æŒ‡å—

## ğŸ¯ æ¦‚è¿°

SmartOS é‡‡ç”¨å®Œå…¨æœ¬åœ°åŒ–çš„å¼€å‘æ–¹æ¡ˆï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡å™¨ã€‚æ‰€æœ‰æœåŠ¡éƒ½åœ¨æœ¬åœ°è¿è¡Œï¼ŒåŒ…æ‹¬ï¼š

- âœ… BC4 Pro è®¾å¤‡æ¨¡æ‹Ÿå™¨ï¼ˆHTTP API + MQTTï¼‰
- âœ… æœ¬åœ° MQTT Brokerï¼ˆMosquittoï¼‰
- âœ… æœ¬åœ°æ•°æ®åº“ï¼ˆPostgreSQLï¼‰
- âœ… å…‰æ„Ÿæ•°æ®æ¨¡æ‹Ÿç”Ÿæˆ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœ¬åœ°æœåŠ¡

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨Docker Composeï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆPostgreSQL + Mosquittoï¼‰
docker-compose up -d

# æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬
./scripts/start-local.sh
```

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨

**PostgreSQL**ï¼š
```bash
# macOS
brew install postgresql@14
brew services start postgresql@14

# Ubuntu
sudo apt-get install postgresql-14
sudo systemctl start postgresql
```

**Mosquitto**ï¼š
```bash
# macOS
brew install mosquitto
brew services start mosquitto

# Ubuntu
sudo apt-get install mosquitto
sudo systemctl start mosquitto
```

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
# è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
./scripts/init-db.sh

# æˆ–æ‰‹åŠ¨åˆ›å»º
createdb smartos
```

### 3. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
mvn clean install
mvn spring-boot:run
```

åç«¯å°†åœ¨ `http://localhost:8080` å¯åŠ¨

### 4. å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd frontend
npm install
npm run dev
```

å‰ç«¯å°†åœ¨ `http://localhost:5173` å¯åŠ¨

---

## ğŸ§ª æµ‹è¯•Mock API

### 1. æµ‹è¯•è®¾å¤‡çŠ¶æ€API

```bash
curl http://localhost:8080/mock/bc4/BC4_001/status
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "deviceId": "BC4_001",
    "online": true,
    "batteryLevel": 85,
    "signalStrength": -65,
    "firmwareVersion": "1.0.0",
    "timestamp": "2024-01-01T12:00:00"
  }
}
```

### 2. æµ‹è¯•å…‰æ„Ÿæ•°æ®API

```bash
curl http://localhost:8080/mock/bc4/BC4_001/lightSensor
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "deviceId": "BC4_001",
    "lightValue": 450.5,
    "timestamp": "2024-01-01T12:00:00",
    "dataSource": "mock",
    "unit": "lux"
  }
}
```

### 3. æµ‹è¯•è®¾å¤‡å‘½ä»¤API

```bash
curl -X POST http://localhost:8080/mock/bc4/BC4_001/command \
  -H "Content-Type: application/json" \
  -d '{
    "command": "getStatus",
    "params": {
      "property": "lightSensor"
    }
  }'
```

### 4. æµ‹è¯•MQTTæ¶ˆæ¯

**è®¢é˜…å…‰æ„Ÿæ•°æ®**ï¼š
```bash
mosquitto_sub -h localhost -t "/smartos/bc4/+/lightSensor" -v
```

**å‘å¸ƒæµ‹è¯•æ¶ˆæ¯**ï¼š
```bash
mosquitto_pub -h localhost -t "/smartos/test" -m "Hello MQTT"
```

---

## ğŸ“Š å…‰æ„Ÿæ•°æ®æ¨¡æ‹Ÿç­–ç•¥

### æ—¶é—´æ¨¡å¼

Mock Controller ä¼šæ ¹æ®å½“å‰æ—¶é—´è‡ªåŠ¨ç”Ÿæˆå…‰æ„Ÿæ•°æ®ï¼š

- **ç™½å¤©ï¼ˆ6:00-18:00ï¼‰**ï¼š200-800 lux
  - ä¸­åˆ12:00æœ€é«˜ï¼ˆ~800 luxï¼‰
  - æ—©æ™šè¾ƒä½ï¼ˆ~200 luxï¼‰
  
- **å¤œæ™šï¼ˆ18:00-6:00ï¼‰**ï¼š0-50 lux
  - éšæœºç”Ÿæˆï¼Œæ¨¡æ‹Ÿå¤œé—´å…‰ç…§

### è‡ªå®šä¹‰æ•°æ®ç”Ÿæˆ

å¯ä»¥ä¿®æ”¹ `BC4MockController.generateLightValue()` æ–¹æ³•æ¥è‡ªå®šä¹‰æ•°æ®ç”Ÿæˆç­–ç•¥ï¼š

```java
private double generateLightValue() {
    // è‡ªå®šä¹‰ç”Ÿæˆé€»è¾‘
    // ä¾‹å¦‚ï¼šä»æ–‡ä»¶è¯»å–ã€ä½¿ç”¨ç®—æ³•ç­‰
}
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### å¯ç”¨/ç¦ç”¨Mockæ¨¡å¼

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
smartos:
  local:
    enabled: true  # true=ä½¿ç”¨Mockï¼Œfalse=ä½¿ç”¨çœŸå®è®¾å¤‡
```

### Mockè®¾å¤‡é…ç½®

```yaml
smartos:
  local:
    mock-device:
      enabled: true
      base-url: http://localhost:8080/mock/bc4
```

### MQTTé…ç½®

```yaml
smartos:
  mqtt:
    broker-url: tcp://localhost:1883
    client-id: smartos-client
```

---

## ğŸ¯ åˆ‡æ¢åˆ°çœŸå®è®¾å¤‡

å½“éœ€è¦è¿æ¥çœŸå®BC4 Proè®¾å¤‡æ—¶ï¼š

1. **ä¿®æ”¹é…ç½®**ï¼š
```yaml
smartos:
  local:
    enabled: false  # ç¦ç”¨Mockæ¨¡å¼
  
  bc4:
    api:
      base-url: https://mall-cn.superacme.com  # çœŸå®APIåœ°å€
```

2. **ä»£ç æ— éœ€ä¿®æ”¹**ï¼Œé€šè¿‡é…ç½®å³å¯åˆ‡æ¢ï¼

---

## ğŸ“ å¼€å‘å»ºè®®

### 1. ä½¿ç”¨Mockæ¨¡å¼å¼€å‘

- âœ… å¿«é€Ÿè¿­ä»£ï¼Œæ— éœ€ç­‰å¾…çœŸå®è®¾å¤‡
- âœ… å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯
- âœ… ä¾¿äºè‡ªåŠ¨åŒ–æµ‹è¯•

### 2. å®šæœŸæµ‹è¯•çœŸå®è®¾å¤‡

- åœ¨å…³é”®åŠŸèƒ½å®Œæˆåï¼Œåˆ‡æ¢åˆ°çœŸå®è®¾å¤‡æµ‹è¯•
- éªŒè¯é€šä¿¡åè®®çš„æ­£ç¡®æ€§
- å‘ç°æ½œåœ¨é—®é¢˜

### 3. ä¿æŒMockå’ŒçœŸå®APIçš„ä¸€è‡´æ€§

- Mock APIåº”è¯¥å°½é‡æ¨¡æ‹ŸçœŸå®APIçš„è¡Œä¸º
- ä¿æŒæ¥å£ç­¾åä¸€è‡´
- ä¿æŒæ•°æ®æ ¼å¼ä¸€è‡´

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. MQTTè¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šæ— æ³•è¿æ¥åˆ°MQTT Broker

**è§£å†³**ï¼š
- æ£€æŸ¥Mosquittoæ˜¯å¦è¿è¡Œï¼š`docker ps | grep mosquitto`
- æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :1883`
- æŸ¥çœ‹Mosquittoæ—¥å¿—ï¼š`docker logs smartos-mosquitto`

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šæ— æ³•è¿æ¥åˆ°PostgreSQL

**è§£å†³**ï¼š
- æ£€æŸ¥PostgreSQLæ˜¯å¦è¿è¡Œï¼š`docker ps | grep postgres`
- æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨ï¼š`psql -U smartos -d smartos -c "SELECT 1"`
- æ£€æŸ¥è¿æ¥é…ç½®ï¼š`application.yml` ä¸­çš„æ•°æ®åº“é…ç½®

### 3. Mock APIæ— å“åº”

**é—®é¢˜**ï¼šè®¿é—®Mock APIè¿”å›404

**è§£å†³**ï¼š
- æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨
- æ£€æŸ¥URLè·¯å¾„æ˜¯å¦æ­£ç¡®ï¼š`/mock/bc4/{deviceId}/status`
- æŸ¥çœ‹åç«¯æ—¥å¿—

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æœ¬åœ°åŒ–å¼€å‘æ–¹æ¡ˆ](./æœ¬åœ°åŒ–å¼€å‘æ–¹æ¡ˆ.md)
- [shenmoué€šä¿¡åè®®åˆ†æ](./shenmou_é€šä¿¡åè®®åˆ†æ.md)
- [BC4 Proå…‰æ„Ÿçª—å¸˜é›†æˆæ–¹æ¡ˆ](../BC4_Pro_å…‰æ„Ÿçª—å¸˜é›†æˆæ–¹æ¡ˆ.md)

---

**ç¥å¼€å‘é¡ºåˆ©ï¼** ğŸš€
